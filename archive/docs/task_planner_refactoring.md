# Task Planner 系统重构设计

## 1. 当前系统问题

当前 Task Planner 系统在任务执行和结果传递方面存在以下问题：

1. **上下文传递机制过于复杂**：
   - 当前系统使用复杂的内存中对象进行任务上下文传递
   - TaskContext 和 ContextManager 类包含大量用于内存中数据管理的代码
   - 在任务间传递数据需要复杂的 propagate_results 调用

2. **规划者承担过多职责**：
   - 规划者不仅负责任务拆分，还要处理上下文传递细节
   - process_result 方法需要解析和处理执行者返回的复杂结构

3. **执行者的能力未充分利用**：
   - 执行者（Claude）完全有能力直接管理文件输出
   - 当前系统通过复杂的解析从执行者输出中提取工件，而不是直接让执行者输出到文件

4. **系统稳定性问题**：
   - 内存中对象传递容易出错，特别是在任务数量增加时
   - 解析执行者输出提取工件的逻辑容易受到输出格式变化的影响

## 2. 重构目标

通过重构，我们希望实现以下目标：

1. **简化任务结果传递机制**：
   - 采用基于文件的方式传递任务结果和工件
   - 执行者直接将结果写入文件，而不是通过内存传递

2. **明确职责分工**：
   - 规划者专注于任务拆分和协调
   - 执行者负责完成任务并将结果写入指定文件

3. **保持动态规划能力**：
   - 规划者仍然需要读取执行结果以评估任务进展
   - 保留根据执行结果动态调整计划的能力

4. **提高系统稳定性**：
   - 减少内存中对象传递带来的风险
   - 通过文件系统提供更可靠的数据持久化

## 3. 核心修改设计

### 3.1 子任务定义格式修改

新的子任务定义格式将明确指定输入和输出文件路径：

```json
{
  "id": "task_1",
  "name": "数据分析",
  "instruction": "分析输入数据，生成统计报告",
  "input_files": {
    "raw_data": "data/input.csv"
  },
  "output_files": {
    "main_result": "results/task_1/analysis.json",
    "report": "results/task_1/report.md",
    "plots": "results/task_1/plots/"
  },
  "success_criteria": [
    "必须生成有效的统计报告",
    "分析结果必须包含至少3个关键指标"
  ],
  "dependencies": []
}
```

依赖任务示例：

```json
{
  "id": "task_2",
  "name": "模型训练",
  "instruction": "基于分析结果训练模型",
  "input_files": {
    "analysis": "results/task_1/analysis.json"
  },
  "output_files": {
    "model": "results/task_2/model.pkl",
    "metrics": "results/task_2/metrics.json"
  },
  "success_criteria": [
    "模型准确率必须大于80%",
    "必须保存可用的模型文件"
  ],
  "dependencies": ["task_1"]
}
```

### 3.2 执行者提示词修改

执行者的提示词将明确指导如何将结果保存到文件：

```
# 任务：{task_name}
{instruction}

## 文件路径和结果要求
请将所有生成的结果保存到以下文件：
- 主要结果JSON：{output_file_path}
- 其他工件：{artifacts_dir}/

结果JSON必须包含以下字段：
- success：表示任务是否成功完成
- result：包含summary和details
- artifacts：所有生成文件的路径列表

## 前置任务结果
以下是前置任务的结果文件，你可以直接读取：
{dependency_files}

## 成功标准
任务被视为成功需要满足：
{success_criteria}

## 任务进度
当前任务：{current}/{total}
已完成任务：{completed_count}
```

### 3.3 结果JSON格式

执行者生成的结果JSON文件格式：

```json
{
  "task_id": "task_1",
  "success": true,
  "result": {
    "summary": "成功分析了数据集，发现三个主要趋势",
    "details": "详细分析结果..."
  },
  "artifacts": {
    "report": "/path/to/report.md",
    "plot1": "/path/to/plot1.png",
    "plot2": "/path/to/plot2.png"
  },
  "next_steps": [
    "建议对数据集A进行进一步分析",
    "考虑增加更多特征变量"
  ]
}
```

## 4. 具体修改内容

### 4.1 修改 TaskPlanner 类

1. **修改 break_down_task 方法**：
   - 更新提示词，要求Claude生成包含输入/输出文件路径的子任务定义
   - 为每个子任务创建必要的输出目录结构

2. **修改 get_next_subtask 方法**：
   - 简化上下文传递，只传递前置任务的文件路径信息
   - 不再复制前置任务的结果内容

3. **修改 process_result 方法**：
   - 从结果JSON文件中读取执行结果
   - 根据文件内容评估任务完成情况
   - 保留任务成功/失败记录

4. **保留 _evaluate_and_adjust_plan 方法**：
   - 读取结果文件评估任务进展
   - 保留动态调整计划的能力
   - 调整后生成新的子任务定义文件

### 4.2 修改 TaskExecutor 类

1. **修改 _prepare_context_aware_prompt 方法**：
   - 更新提示词，明确指导将结果保存到文件
   - 提供前置任务的结果文件路径，而非内容
   - 添加文件输出要求和格式规范

2. **精简 _extract_and_store_artifacts_from_text 方法**：
   - 主要验证文件是否成功生成
   - 简化工件提取逻辑，主要依赖执行者自己的文件输出

3. **修改 execute_subtask 方法**：
   - 确保输出目录存在
   - 更新结果处理逻辑，主要验证文件生成情况

### 4.3 简化 ContextManager 类

1. **精简 TaskContext 类**：
   - 主要存储文件路径信息，而非内容
   - 简化工件管理，主要记录文件位置

2. **修改 propagate_results 方法**：
   - 主要传递文件路径，而非内容
   - 简化实现，降低复杂度

### 4.4 文件组织结构

为每个任务创建清晰的目录结构：

```
logs/
├── task_20230401_120000/
│   ├── subtasks/
│   │   ├── task_1.json  # 子任务定义
│   │   ├── task_2.json
│   │   └── ...
│   ├── results/
│   │   ├── task_1/
│   │   │   ├── result.json  # 主要结果
│   │   │   ├── report.md
│   │   │   └── plots/
│   │   ├── task_2/
│   │   │   ├── result.json
│   │   │   ├── model.pkl
│   │   │   └── ...
│   ├── plan.json  # 整体任务计划
│   └── final_result.json  # 最终整合结果
```

## 5. 实施步骤

1. **更新子任务定义格式**：
   - 修改 `_build_breakdown_prompt` 方法生成新格式的子任务定义
   - 更新 `_normalize_subtasks` 方法处理新格式

2. **修改执行者提示词**：
   - 更新 `_prepare_context_aware_prompt` 方法
   - 添加文件路径和格式要求

3. **添加文件管理功能**：
   - 为每个任务创建输出目录
   - 确保文件路径有效

4. **更新结果处理逻辑**：
   - 修改 `process_result` 方法从文件读取结果
   - 更新结果评估和计划调整逻辑

5. **精简上下文管理**：
   - 简化 TaskContext 和 ContextManager 类
   - 聚焦于文件路径管理而非内容管理

6. **测试与验证**：
   - 测试单个子任务执行
   - 测试复杂任务的完整流程
   - 验证动态规划调整功能

## 6. 预期效果

1. **简化系统架构**：
   - 减少内存中对象传递的复杂度
   - 明确规划者和执行者的职责分工

2. **提高系统稳定性**：
   - 通过文件系统提供更可靠的数据持久化
   - 减少内存中对象传递带来的风险

3. **增强可调试性**：
   - 所有中间结果都保存为文件，便于检查和调试
   - 任务执行过程更透明

4. **保持功能完整性**：
   - 保留任务分析和拆分能力
   - 保留根据执行结果动态调整计划的能力
   - 保留最终结果整合能力

## 7. 分模块测试计划

为了确保重构后的系统各个组件正常工作，我们设计了以下分模块测试计划：

### 7.1 单元测试计划

#### 1. 新版 TaskContext 测试（test_task_context.py）✅

- **测试文件路径管理功能**：✅
  - 测试 `add_file_reference` 方法 ✅
  - 测试文件类型自动识别功能 ✅
  - 测试 `get_file_content` 方法 ✅

- **测试序列化与反序列化**：✅
  - 验证包含文件路径的上下文能否正确序列化和反序列化 ✅
  - 测试序列化到文件和从文件加载的功能 ✅

#### 2. 新版 ContextManager 测试（test_context_manager.py）✅

- **测试目录结构创建**：✅
  - 测试 `create_output_directories` 方法 ✅
  - 验证子任务目录结构是否正确创建 ✅

- **测试基于文件的结果传递**：✅
  - 测试修改后的 `propagate_results` 方法 ✅
  - 验证文件引用是否正确传递 ✅

- **测试执行摘要生成**：✅
  - 验证 `get_execution_summary` 是否能正确读取结果文件 ✅

#### 3. TaskPlanner 关键方法测试（test_task_planner.py）

- **测试 break_down_task**：
  - 验证生成的子任务定义是否包含正确的输入输出文件路径
  - 测试目录结构创建是否成功

- **测试 get_next_subtask**：
  - 验证依赖关系处理和文件路径传递

- **测试 process_result**：
  - 测试从文件读取结果
  - 测试结果处理逻辑

- **测试 _evaluate_and_adjust_plan**：
  - 验证能否从文件正确评估任务
  - 测试计划调整逻辑

#### 4. TaskExecutor 方法测试（test_task_executor.py）

- **测试 _prepare_context_aware_prompt**：
  - 验证生成的提示词是否包含正确的文件路径信息
  - 检查提示词格式是否符合要求

- **测试 execute_subtask**：
  - 测试输出目录创建
  - 测试结果文件处理

- **测试 _extract_and_store_artifacts_from_text**：
  - 验证工件是否成功保存到文件系统
  - 测试文件引用是否正确添加到上下文

### 7.2 集成测试计划

#### 1. 子系统集成测试（test_subsystem_integration.py）

- **测试 Planner 和 ContextManager 集成**：
  - 验证任务拆分和上下文管理的协调工作

- **测试 Executor 和 ContextManager 集成**：
  - 验证任务执行和文件管理的交互

#### 2. 端到端流程测试（test_end_to_end.py）

- **单任务执行测试**：
  - 测试单个任务的完整执行流程

- **多任务链式执行测试**：
  - 测试具有依赖关系的多个任务的执行流程

- **错误处理和计划调整测试**：
  - 模拟任务失败场景
  - 测试动态计划调整功能

### 7.3 功能测试计划

#### 1. 基本功能测试（test_basic_features.py）

- **任务分析功能**：
  - 测试分析任务描述并生成分析结果

- **任务拆分功能**：
  - 测试拆分复杂任务为子任务

- **任务执行功能**：
  - 测试执行单个子任务

#### 2. 高级功能测试（test_advanced_features.py）

- **文件传递功能**：
  - 测试任务间的文件传递

- **动态计划调整功能**：
  - 测试基于执行结果调整计划

- **结果整合功能**：
  - 测试整合所有子任务结果

### 7.4 特殊场景测试

#### 1. 大规模任务测试（test_large_scale.py）

- **大量子任务测试**：
  - 测试系统处理大量子任务的能力

- **大文件处理测试**：
  - 测试系统处理大型输入/输出文件的能力

#### 2. 容错性测试（test_fault_tolerance.py）

- **执行失败恢复测试**：
  - 测试从任务失败中恢复的能力

- **中断恢复测试**：
  - 测试从系统中断中恢复的能力

### 7.5 测试实施计划和进度

#### 测试进度

- **单元测试：**
  - TaskContext ✅ (8/8 测试通过)
  - ContextManager ✅ (8/8 测试通过)
  - TaskPlanner ⏳ (准备中)
  - TaskExecutor ⏳ (准备中)

- **集成测试：**
  - 子系统集成测试 ⏳ (准备中)
  - 端到端流程测试 ⏳ (准备中)

- **功能测试：**
  - 基本功能测试 ⏳ (准备中)
  - 高级功能测试 ⏳ (准备中)
  - 特殊场景测试 ⏳ (准备中)

1. **准备测试环境**：
   - 创建测试目录和测试数据
   - 设置测试配置

2. **编写测试用例**：
   - 按照上述分类编写测试用例
   - 为每个测试用例准备预期输出

3. **执行测试**：
   - 首先执行单元测试
   - 然后执行集成测试
   - 最后执行功能测试和特殊场景测试

4. **测试报告**：
   - 记录测试结果
   - 分析测试覆盖率
   - 整理测试发现的问题

5. **测试迭代**：
   - 修复测试发现的问题
   - 重新运行测试验证修复效果